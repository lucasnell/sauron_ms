
\section*{Methods}


\subsection*{Model overview}

We used a simple model of competition to evaluate how evolving competitive traits
affect the outcomes of community assembly.
Each of $n$ species has $q$ traits that affect competition.
These traits do not define the species (i.e., species that evolve to have
the same trait values are still considered separate species).
This is done for two reasons:
First, we aim to keep the speciation process explicitly
separate from the processes we are simulating.
Second, we seek to minimize the constrains on our definition of a trait
in this context to keep the model general.


All traits are symmetrical in that the benefits and tradeoffs are 
the same for all $q$ traits.
All species are symmetrical in that when species share the same trait values and abundance, 
they will always have the same effect on each other.
Increases in traits benefit the species via reduced
effects of both interspecific and intraspecific competition;
they also incur a cost by decreasing the species' population growth rate.
In both the costs and benefits, trait effects are concave functions that,
combined, ensure that one fitness peak exists for each trait.
Traits can also have non-additive trade-offs that either increase or decrease
the cost associated with increasing multiple traits compared to increasing
just one.


The competition experienced by each species is a product of the traits in all
species in the community.
Trait evolution can be either conflicting or non-conflicting:
When conflicting, greater trait values for a species increase the effects of
competition for all other species.
When non-conflicting, all competitors' competition is reduced when traits
increase in one species.


We used a discrete-time, modified Lotka--Volterra competition model similar to
that by \citet{Northfield:2013if}.
In it, species $i$ has a length-$q$ vector of traits ($\mathbf{v}_i$), and
its per-capita growth---equivalent to fitness---is

\begin{equation} \label{eq:fitness}
    F_{i} = \exp \left\{ r_i(\mathbf{v}_i) - 
        \alpha_{ii}(\mathbf{v}_i) \, N_i - \sum_{j \ne i}^{n}{
            \alpha_{ij}(\mathbf{v}_i, \mathbf{v}_j) \, N_j}  
    \right\}\textrm{,}
\end{equation}

\noindent where $N_i$ is the population density of  species $i$.
The parameter $r(\mathbf{v}_i)$ describes how traits affect
the growth rate:

\begin{equation} \label{eq:growth-rate}
\begin{split}
    r(\mathbf{v}_i) &= r_0 - f \, \mathbf{v}_i^{\textrm{T}} \, \mathbf{C} ~ \mathbf{v}_{i} \\
    \mathbf{C} &= \begin{pmatrix}
        1         & \ldots & \eta_{1q} \\
        \vdots    & \ddots & \vdots \\
        \eta_{q1} & \ldots & 1      \\
        \end{pmatrix}
    \textrm{,}
\end{split}
\end{equation}

\noindent where $r_0$ is the baseline growth rate,
$f$ is the cost of increasing traits on the growth rate, and
$\eta_{k,l}$ is the non-additive trade-off of increasing both the
$k$\textsuperscript{th} and $l$\textsuperscript{th} traits.
When $\eta > 0$, increasing multiple traits incurs an extra cost.
Non-additive trade-offs are symmetrical (i.e., $\eta_{k,l} = \eta_{l,k}$ for all
$l$ and $k$), and all values on the diagonal of $\mathbf{C}$ are 1.


The terms $\alpha_{ii}(\mathbf{v}_i)$ and
$\alpha_{ij}(\mathbf{v}_i, \mathbf{v}_j)$
in equation \ref{eq:fitness} represent how traits influence the effects
of intraspecific and interspecific competition, respectively.
Competitive effects are given by

\begin{equation} \label{eq:competition}
\begin{split}
    \alpha_{ii}(\mathbf{v}_i) &= \alpha_0 ~\exp \left\{
        - \mathbf{v}_i^{\textrm{T}}
        \mathbf{v}_i \right\} \\
    \alpha_{ij}(\mathbf{v}_i, \mathbf{v}_j) &= \alpha_0 ~\exp \left\{
        - \mathbf{v}_i^{\textrm{T}} \mathbf{v}_i -
        \mathbf{v}_j^{\textrm{T}} \mathbf{D} \mathbf{v}_j \right\} \\
    \mathbf{D} &= \begin{pmatrix}
        d_1     & \ldots    & 0 \\
        \vdots  & \ddots    & \vdots \\
        0       & \ldots    & d_q
        \end{pmatrix}
	\textrm{,}
\end{split}
\end{equation}

\noindent where $\alpha_0$ is the base density dependence.
Matrix $\mathbf{D}$ contains parameters that determine how evolution of traits
in one species affects competition experienced by others:
When $d_k < 0$, increases in $v_{i,k}$ decrease the
effect of competition on species $i$, but increase it in all others.
Alternatively, when $d_k > 0$, increases in $v_{i,k}$ decrease the effect of
competition on all species including itself.
Thus $d_k < 0$ causes conflicting and $d_k > 0$ causes non-conflicting evolution
for trait $k$ \citep{Northfield:2013if}.
We could expect conflicting evolution to occur when contest competition
leads to arms races among competitors
\citep{Abrams:1994th}.
Competitor evolution might be non-conflicting when they evolve
dissimilar traits to reduce competition for resources \citep{Roughgarden:1976eh}.
Hereafter, $\mathbf{d}$ refers to the vector $\{d_1, \; \ldots, \; d_q \}$.


The relationships between trait values and other components of fitness
(growth rates and effects of competition) are of the form
$X \propto v^2$ for parameter $X$, so $v = z$ is equivalent to $v = -z$.
To avoid alternative outcomes due to artifacts of this relationship,
traits are not allowed to be $< 0$.
We did this by passing the equation for $\mathbf{v}_{t+1}$ through a
ramp function.
We used a ramp function instead of absolute values
because the latter causes fluctuations
in the trait values when they approach zero (they ``bounce off''
the zero bound) that persist for a very long time;
this caused the simulations to take a prohibitively long time to reach
equilibrium.
A more important disadvantage is that $d \lvert x \rvert / dx$ is
undefined when $x = 0$.
This implementation and its consequences on resulting derivatives are in
Appendix A.




% \subsection*{Adaptive dynamics}
%
% We started simulations with a single competitive species with trait values set to zero.
% We tracked species population densities through time using equation \ref{eq:fitness} and
% considered a species extinct if its density fell below $10^{-4}$.
% Species produced daughter species with a probability of 0.01 per species per time step.
% We generated daughter-species trait values from normal distributions with means of the
% mother trait values and standard deviations of $\sigma_{d}$.


\subsection*{Quantitative genetics}

We used a quantitative genetics framework for trait evolution.
We assumed that all traits in $\mathbf{v}_i$ represent means for species $i$
and that their among-individual distributions are symmetrical with additive
genetic variance $\sigma^2_i$.
Assuming also that $\sigma^2_i$ is relatively small
\citep{Iwasa:1991eo,Abrams:2001va,Abrams:1993cr}, traits at time $t+1$ are

\begin{equation} \label{eq:trait-change}
    \mathbf{v}_{i,t+1} = \mathbf{v}_{i,t} + \left( \frac{1}{F_i}
        \frac{\partial F_i}{\partial \mathbf{v}_{i,t}} \right) \sigma^2_i
    \textrm{.}
\end{equation}

To determine the stability of ending points (trait values and abundances of
surviving competitor(s)), we computed the $n (q+1) \times n (q+1)$ Jacobian matrices
of first derivatives for the traits and abundances of each species:

\begin{equation} \label{eq:jacobian}
    \begin{pmatrix}
        \frac{\partial \mathbf{v}_{1,t+1}}{\partial \mathbf{v}_{1,t}} & \cdots &
            \frac{\partial \mathbf{v}_{1,t+1}}{\partial \mathbf{v}_{n,t}} &
            \frac{\partial \mathbf{v}_{1,t+1}}{\partial N_{1,t}} & \cdots &
            \frac{\partial \mathbf{v}_{1,t+1}}{\partial N_{n,t}} \\
        \vdots & \ddots & \vdots & \vdots & \ddots & \vdots \\
        \frac{\partial \mathbf{v}_{n,t+1}}{\partial \mathbf{v}_{1,t}} & \cdots &
            \frac{\partial \mathbf{v}_{n,t+1}}{\partial \mathbf{v}_{n,t}} &
            \frac{\partial \mathbf{v}_{n,t+1}}{\partial N_{1,t}} & \cdots &
            \frac{\partial \mathbf{v}_{n,t+1}}{\partial N_{n,t}} \\[1ex]
%
%
        \frac{\partial N_{1,t+1}}{\partial \mathbf{v}_{1,t}} & \cdots &
            \frac{\partial N_{1,t+1}}{\partial \mathbf{v}_{n,t}} &
            \frac{\partial N_{1,t+1}}{\partial N_{1,t}} & \cdots &
            \frac{\partial N_{1,t+1}}{\partial N_{n,t}} \\
        \vdots & \ddots & \vdots & \vdots & \ddots & \vdots \\
        \frac{\partial N_{n,t+1}}{\partial \mathbf{v}_{1,t}} & \cdots &
            \frac{\partial N_{n,t+1}}{\partial \mathbf{v}_{n,t}} &
            \frac{\partial N_{n,t+1}}{\partial N_{1,t}} & \cdots &
            \frac{\partial N_{n,t+1}}{\partial N_{n,t}} \\
    \end{pmatrix}
    \text{.}
\end{equation}

\noindent We then computed the primary eigenvalue of this matrix ($\lambda$).
We considered a state stable when $\lambda < 1$,
neutrally stable when $\lambda = 1$,
and unstable when $\lambda > 1$.

Full analytical solutions to matrix derivatives (for trait change and
Jacobian matrices) are found in appendix A.

We also analyzed equilibrium solutions for the 2 trait case.
This is found in Appendix B.


\subsection*{Stochasticity}

We added stochasticity to population dynamics by simply adding 
a log-normal error term:

\begin{equation} \label{eq:N-stochasticity}
\begin{split}
    N_{i,t+1} &= N_{i,t} \, F_{i,t} \; \text{e}^{\varepsilon_N} \\
    \varepsilon_N &\sim \text{N}(0, \, \sigma^2_N)
    \text{.}
\end{split}
\end{equation}


Stochasticity for trait evolution takes the form of non-adaptive
phenotypic plasticity,
where phenotypes ($\mathbf{\ddot{v}}$) are the product of the
genotypes ($\mathbf{v}$) and a log-normal error term:

\begin{equation} \label{eq:V-stochasticity}
\begin{split}
    \mathbf{\ddot{v}}_{i,t+1} &= \mathbf{v}_{i,t+1} \; \text{e}^{\varepsilon_V} \\
    \varepsilon_V &\sim \text{N}(0, \, \sigma^2_V)
    % \varepsilon_V &\sim \text{N}(\mu_V, \, \sigma^2_V)
    \text{.}
\end{split}
\end{equation}

% \noindent To keep stochasticity from affecting the direction of trait evolution, 
% we set $\mu_V$ to $-\sigma^2_V / 2$, so that the mean of $\text{e}^{\varepsilon_V}$ was 1.

Because the phenotypes interact with the environment, they are used
to calculate all species' fitness values.
Genotypes change through time based on the previous time point's 
genotypes and how the phenotypes affect fitness:

\begin{equation} \label{eq:trait-change-stochastic}
    \mathbf{v}_{i,t+1} = \mathbf{v}_{i,t} + \left( \frac{1}{F_i}
        \frac{\partial F_i}{\partial \mathbf{\ddot{v}}_{i,t}} \right) \sigma^2_i
    \textrm{.}
\end{equation}





\subsection*{Simulations}

We started simulations with one species, and each of 99 new species
was added every 500 generations.
We continued simulations for another 20,000 generations after all
species were added.
Each species had starting trait values generated from a truncated normal distribution 
with a mean equal to the equilibrium solution for that trait,
a standard deviation of 1, and a lower bound of zero.
Species started with an abundance of 1.
We tracked densities through time and considered a species extinct if its 
density fell below $10^{-4}$.


% When generating multiple $\eta$ magnitudes for the different tradeoffs,
% we did so using a uniform distribution from 0.1 to 0.4.
% We intentionally avoided the use of simple $\eta$ values because
% when the sum of one or more $\eta$ equals another, this simplifies
% to additivity even when those $\eta \ne 0$.
% This only applies in the case of $q > 2$, since there is only one
% $\eta$ value when $q = 2$.
% When $q = 2$, we chose $\eta = 0.6$ because it was sufficiently large
% to show how its value changes the pattern of outcomes.

For simulations that aim to find points in trait space associated with
species surviving competitive environments, we set $d = 1$ 
(non-conflicting evolution) so that many species
survived and surveyed the trait space more effectively.
% This has the added benefit of being a symmetric case where
% all species in the community benefit equally when one
% species evolves an increased trait.


% We first simulated 2-trait communities to survey many of the
% basic properties of the model.
% Next, we simulated 3- and 4-trait communities.
% With 3 traits, there is more than one tradeoff, so we could
% explore combinations of different types of additivity.
% With 4 traits, there are more tradeoffs than traits, which we
% thought might cause different possibilities in the model.



\subsection*{Code}

We simulated models using a combination of R \citep{RCoreTeam:2019wf} and
C++ via the Rcpp and RcppArmadillo packages
\citep{Eddelbuettel:2014ad,Eddelbuettel:2013if,Sanderson:2016cs}.
We double-checked our derivations by simulating 100 datasets
(4 species with 3 traits each) and computing derivatives using the Theano Python
library's automatic differentiation \citep{TheanoDevelopmentTeam:2016uc}.
All code can be found on GitHub
% AmNat does double-blind reviews, so the next line will be un-commented after review
% (\texttt{https://github.com/lucasnell/sauron}).
(links are available from the journal office).

